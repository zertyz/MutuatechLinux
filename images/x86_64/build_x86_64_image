#!/usr/bin/env bash
set -euo pipefail

# --- Tunables ---
IMG="${IMG:-artifacts/mutuatechlinux-general-x86_64.img}"
IMG_SIZE="${IMG_SIZE:-4G}"
ESP_SIZE="${ESP_SIZE:-4MiB}"
SWAP_SIZE="${SWAP_SIZE:-1GiB}"
HOST_AUTH_KEYS="${HOST_AUTH_KEYS:-$HOME/.ssh/authorized_keys}"  # copied to root
HOSTNAME="${HOSTNAME:-MutuatechLinux}"
FS_LABEL="${FS_LABEL:-mtl_root}"
ROOT_PW="${ROOT_PW:-mutuatechlinux}"              # optional; if empty, root password stays locked
DEF_USER="${DEF_USER:-}"            # e.g. 'arch'
DEF_USER_PW="${DEF_USER_PW:-}"      # optional
TIMEZONE="${TIMEZONE:-UTC}"

# Minimal set; you can add 'rust paru' here if desired:
BASE_PKGS=(base base-devel linux linux-firmware intel-ucode amd-ucode btrfs-progs compsize gptfdisk parted cloud-guest-utils wget grub efibootmgr net-tools dhclient openssh openbsd-netcat vim sudo rust paru)

# Your original cache setup (kept)
ONLINE_PACKAGES=(
  'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
  'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'
)

[ "$EUID" -ne 0 ] && { echo "Please run this as root: sudo $0" >&2; exit 1; }

mkdir -p artifacts

CACHE_DIR="cache"
mkdir -p "$CACHE_DIR"
if ! ls "$CACHE_DIR"/*.pkg.tar.* >/dev/null 2>&1; then
  echo "Fetching example cache pkgs (adjust as you already do)..."
  ( cd "$CACHE_DIR"
    wget -c \
      http://mutuatech.com/MutuatechLinux/cache/x86_64/{mutuatechlinux-general-multiarch-1.1.40-1-x86_64.pkg.tar.zst,mutuatechlinux-general-x86_64-1.1.40-1-x86_64.pkg.tar.zst,httpstat-go-1.1.0-1-x86_64.pkg.tar.zst,rar-7.12-1-x86_64.pkg.tar.zst}
  )
fi

require() { command -v "$1" >/dev/null || { echo "Missing: $1"; exit 1; }; }
for bin in sgdisk sfdisk losetup mkfs.fat mkswap mkfs.btrfs pacstrap arch-chroot genfstab grub-install grub-mkconfig partprobe; do # taken out of the list: 'qemu-img'
  require "$bin"
done

cleanup() {
  set +e
  if mountpoint -q "$MNT/boot/efi"; then umount -l "$MNT/boot/efi"; fi
  if mountpoint -q "$MNT"; then umount -l "$MNT"; fi
  if [[ -n "${LOOPDEV:-}" ]]; then losetup -d "$LOOPDEV"; fi
  [[ -d "${MNT:-}" ]] && rmdir "$MNT"
}
trap cleanup EXIT

# 1) Create sparse raw file
echo ">> Creating image file: $IMG ($IMG_SIZE)"
rm -f "$IMG"
truncate -s "$IMG_SIZE" "$IMG"

## 2) GPT layout: 1=ESP, 2=swap, 3=root
#echo ">> Partitioning GPT (ESP ${ESP_SIZE}, swap ${SWAP_SIZE}, root=rest)"
#sgdisk -Z "$IMG"
#sgdisk -n 1:0:+"$ESP_SIZE" -t 1:EF00 -c 1:"EFI System" "$IMG"
#sgdisk -n 2:0:+"$SWAP_SIZE" -t 2:8200 -c 2:"swap" "$IMG"
#sgdisk -n 3:0:0        -t 3:8300 -c 3:"${FS_LABEL}" "$IMG"
#sgdisk -p "$IMG"

# 2) MBR/DOS layout: 1=ESP, 2=swap, 3=root
echo ">> Partitioning MBR/DOS (ESP ${ESP_SIZE}, swap ${SWAP_SIZE}, root=rest)"
sfdisk "$IMG" <<EOF
label: dos

# p1: ESP (FAT32), bootable
start=1MiB, size=${ESP_SIZE}, type=ef, bootable

# p2: swap
size=${SWAP_SIZE}, type=82

# p3: root (rest of disk)
type=83
EOF

# 3) Map loop device with partitions
LOOPDEV="$(losetup --find --show -P "$IMG")"
echo ">> Loop device to be used: $LOOPDEV"
partprobe "$LOOPDEV"

P1="${LOOPDEV}p1"
P2="${LOOPDEV}p2"
P3="${LOOPDEV}p3"

# 4) Filesystems
echo ">> mkfs ESP FAT32"
mkfs.fat -F12 -n EFI "$P1"
echo ">> mkswap"
mkswap -L swap "$P2"
echo ">> mkfs Btrfs root"
mkfs.btrfs -f -L "${FS_LABEL}" "$P3"

# 5) Mount with max zstd and sane opts
MNT="$(mktemp -d)"
echo ">> Mounting root at $MNT"
mount -o defaults,compress-force=zstd:15,noatime,commit=600 "$P3" "$MNT"
mkdir -p "$MNT/boot/efi"
mount "$P1" "$MNT/boot/efi"

# 6) Bootstrap Arch
echo ">> pacstrap base + tools"
pacstrap -M -c -P "$MNT" "${BASE_PKGS[@]}"
pacstrap -M -c -P -U "$MNT" "$CACHE_DIR"/*.pkg.tar* "${ONLINE_PACKAGES[@]}"

# 7) fstab with Btrfs opts (by PARTUUID)
genfstab -t UUID -U "$MNT" >> "$MNT/etc/fstab"
# Harden Btrfs mount options for root
sed -i 's|\(\s/\s*btrfs\s*\)\S*|\1defaults,noatime,compress=zstd:15,commit=600|' "$MNT/etc/fstab"

# genfstab works badly inside AWS and GCE (at least) -- it uses the /dev/ entries instead of the UUID. The bellow fixes that
# (harmless if no /dev/* entries are in use)
cat "$MNT/etc/fstab" | grep -v '#' | grep '/dev/' | while read md; do
	echo $md | sed 's| .*||' | while read ld; do
		UUID=`blkid | grep "$ld" | sed 's|.* \(UUID="[^"]*"\).*|\1|'`; 
		sed -i "s|^$ld|$UUID|g" "$MNT/etc/fstab";
	done;
done

# 8) Basic system config
arch-chroot "$MNT" bash -eux <<'CHROOT_EOF'
ln -sf /usr/share/zoneinfo/UTC /etc/localtime
# hwclock --systohc || true
sed -i 's/^#\(en_US\.UTF-8 UTF-8\)/\1/' /etc/locale.gen
locale-gen
echo 'LANG=en_US.UTF-8' > /etc/locale.conf
echo 'mutuatechlinux' > /etc/hostname

# systemd-networkd (DHCP on any "en*" NIC), resolved
mkdir -p /etc/systemd/network
cat >/etc/systemd/network/20-dhcp.network <<NET
[Match]
Name=en*

[Network]
DHCP=yes
NET

systemctl enable systemd-networkd systemd-resolved sshd

# resolv.conf -> systemd-resolved
#ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

systemctl mask tmp.mount
swap_UUID=`blkid | grep 'LABEL="swap"' | grep loop | tail -n 1 | sed 's|.* UUID="\([^"]*\)".*|\1|'`
sed -i "s|^[^ ]*\( *.*swap.*\)|UUID=$swap_UUID\1|" /etc/fstab

# GRUB (UEFI)
sed -i 's|^#\(.*\.br/.*\)|\1|' /etc/pacman.d/mirrorlist
yes | pacman -S --noconfirm linux
rm -fr /var/cache/pacman/pkg/*
mv /boot/initramfs-linux-fallback.img /boot/initramfs-linux.img
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=MutuatechLinux --recheck --no-nvram --removable
grub-mkconfig -o /boot/grub/grub.cfg
grub-install --target=i386-pc --boot-directory=/boot --recheck "$(grub-probe -t disk /)"    # also support MBR booting
CHROOT_EOF

# activate ttys & uses UUID to boot (just in case...)
sed -i 's| quiet$| console=ttyS0,115200|g' "$MNT/boot/grub/grub.cfg"
ROOT_UUID=`blkid | grep "$P3" | sed 's|.* \(UUID="[^"]*"\).*|\1|'` 
sed -i "s| root=$P3| root=$ROOT_UUID|g" "$MNT/boot/grub/grub.cfg"

# 9) Copy files to the image
echo ">> Copying files to the image"
cd files
for f in *; do
	cp -av "$f" "$MNT/"
	chown -fR root:root "$MNT/$f"
done
cd ..

# echo "NOW IN THE CHROOT ENV. PRESS CTRL-D WHEN DONE"
# arch-chroot "$MNT"

# 9) SSH keys & users
if [[ -f "$HOST_AUTH_KEYS" ]]; then
  echo ">> Installing root authorized_keys from $HOST_AUTH_KEYS"
  install -d -m 700 "$MNT/root/.ssh"
  install -m 600 "$HOST_AUTH_KEYS" "$MNT/root/.ssh/authorized_keys"
  # Key-only root by default
  sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin prohibit-password/' "$MNT/etc/ssh/sshd_config"
  sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' "$MNT/etc/ssh/sshd_config"
fi

if [[ -n "$DEF_USER" ]]; then
  echo ">> Creating user: $DEF_USER"
  arch-chroot "$MNT" useradd -m -G wheel -s /bin/bash "$DEF_USER"
  if [[ -n "$DEF_USER_PW" ]]; then
    echo "${DEF_USER}:${DEF_USER_PW}" | arch-chroot "$MNT" chpasswd
  else
    echo "User created without password; SSH keys recommended."
  fi
  # sudo: passwordless wheel (adjust to taste)
  echo '%wheel ALL=(ALL) NOPASSWD: ALL' > "$MNT/etc/sudoers.d/01-wheel-nopasswd"
  chmod 440 "$MNT/etc/sudoers.d/01-wheel-nopasswd"
fi

if [[ -n "$ROOT_PW" ]]; then
  echo ">> Setting root password"
  echo "root:${ROOT_PW}" | arch-chroot "$MNT" chpasswd
else
  echo ">> Root password locked (use SSH keys)"
  arch-chroot "$MNT" passwd -l root || true
fi

# 10) Preparing for shipping
echo ">> Zeroing the non-used bits of the final image -- for better publishing compression"
arch-chroot "$MNT" bash -eux <<'CHROOT_EOF'
>/fill
chattr +Cm /fill
dd if=/dev/zero of=/fill bs=$((4096*4096)) oflag=sync,append conv=notrunc status=progress || :
rm /fill
sync
CHROOT_EOF

echo ">> Image ready: $IMG"
echo
echo ">> For publishing:"
echo ">> Compress with: 'xz -T1 -1kv $IMG'"
echo ">> Publish with: 'scp -pr ${IMG}.xz mutuatec@mutuatech.com:~/public_html/MutuatechLinux/images/x86_64/'"
echo ">> Build & publish the initrd installation artifacts: 'cd initrd_installer; sudo ./generate_initrd_installer; cd ..'"
echo
echo ">> Test with ./test_image"
